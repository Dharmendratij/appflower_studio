Ext.ns("Ext.ux");Ext.ux.TabMenu=function(){var a,c,e,b;this.init=function(f){a=f;a.on("contextmenu",d)};function d(h,g,j){if(!c){c=new Ext.menu.Menu([{id:a.id+"-save",text:"Save",iconCls:"icon-file-save",handler:function(){Ext.Ajax.request({url:b.fileContentUrl,method:"post",params:{"file":b.file,"code":b.getCode()},success:function(m,n){Ext.Msg.alert("Success","The file was saved !")},failure:function(){Ext.Msg.alert("Failure","The server can't save the file !")}})}},{id:a.id+"-close",text:"Close Tab",iconCls:"icon-file-close",handler:function(){a.remove(e)}},{id:a.id+"-close-others",text:"Close Other Tabs",iconCls:"icon-file-close-others",handler:function(){a.items.each(function(m){if(m.closable&&m!=e){a.remove(m)}})}}])}e=g;if(e.items&&e.items.items[0]&&e.items.items[0].code){b=e.items.items[0]}else{b=e}var f=c.items;f.get(a.id+"-close").setDisabled(!g.closable);var l=true;a.items.each(function(){if(this!=g&&this.closable){l=false;return false}});if(g.itemId=="security"||g.itemId=="designer"){f.get(a.id+"-save").setDisabled(true)}else{f.get(a.id+"-save").setDisabled(false)}f.get(a.id+"-close-others").setDisabled(l);c.showAt(j.getPoint())}};Ext.namespace("afStudio.wi");afStudio.wi.BaseBehavior=function(){};Ext.apply(afStudio.wi.BaseBehavior.prototype,{createBehaviorProperties:function(){return[]},configureFor:function(a){},propertyChanged:function(a){},dumpDataForWidgetDefinition:function(a){return a},setNode:function(a){this.node=a}});Ext.namespace("afStudio.wi");afStudio.wi.WithNamePropertyAsLabelBehavior=Ext.extend(afStudio.wi.BaseBehavior,{propertyChanged:function(a){if(a.id=="name"){this.namePropertyChanged(a)}},namePropertyChanged:function(a){this.node.setText(a.get("value"))}});Ext.namespace("afStudio.wi");afStudio.wi.WithValueTypeBehavior=Ext.extend(afStudio.wi.BaseBehavior,{setValueTypeDataKey:function(a){this.key=a},createBehaviorProperties:function(){return[new afStudio.wi.ValueType().create(),new afStudio.wi.ValueSource().create()]},getValueTypeData:function(a){if(this.key){if(a[this.key]){return a[this.key]}else{return{}}}else{return a}},mergeInValueTypeData:function(b,a){if(this.key){b[this.key]=a}else{for(i in a){b[i]=a[i]}}return b},configureFor:function(c){if(c){var a=this.getValueTypeData(c);this.node.getProperty("valueType").set("value",a["type"]);var b=this.node.getProperty("valueSource");if(a["i:source"]){b.set("value","source")}else{if(a["i:class"]){b.set("value","classAndMethod")}else{if(a["i:item"]){b.set("value","item")}else{if(a["i:static"]){b.set("value","static")}}}}this.valueSourceChanged(a)}},valueSourceChanged:function(e){if(!e){e={}}if(this.node.rendered){var f=this.node.childNodes.length;if(f>0){for(var d=(f-1);d>=0;d--){var c=this.node.childNodes[d];if(c.text=="Value Source"){c.destroy()}}}}switch(this.node.getProperty("valueSource").get("value")){case"source":var b=new afStudio.wi.FieldNodeValueSourceSource();if(e["i:source"]){var a=e["i:source"];a["sourceName"]=a["name"]}break;case"classAndMethod":var b=new afStudio.wi.FieldNodeValueSourceMethod();var a=e;break;case"item":var b=new afStudio.wi.FieldNodeValueSourceItem();if(e["i:item"]){var a=e["i:item"]}break;case"static":var b=new afStudio.wi.FieldNodeValueSourceStatic();if(e["i:static"]){var a=e["i:static"]}break}if(b){if(a){b.configureFor(a)}this.node.appendChild(b)}},propertyChanged:function(a){if(a.id=="valueSource"){this.valueSourceChanged()}},dumpDataForWidgetDefinition:function(c){if(c["valueType"]){delete c.valueType}if(c["valueSource"]){delete c.valueSource}var d=this.node.getProperty("valueType").get("value");var b=this.node.getProperty("valueSource").get("value");var a={};if(d){a["type"]=d}else{a["type"]="orm"}if(a["type"]=="orm"){switch(b){case"source":a["i:source"]={name:c["sourceName"]};delete c["sourceName"];c=this.mergeInValueTypeData(c,a);break;case"classAndMethod":a["i:class"]=c["i:class"];if(c["i:method"]&&c["i:method"]!=""){a["i:method"]={name:c["i:method"],"i:param":c["i:param"]};delete c["i:param"];delete c["i:class"];delete c["i:method"]}c=this.mergeInValueTypeData(c,a);break;case"item":a["i:source"]={name:c["name"]};c=this.mergeInValueTypeData(c,a);break;case"static":a["i:source"]={name:c["name"]};c=this.mergeInValueTypeData(c,a);break}}return c}});Ext.namespace("afStudio.wi");afStudio.wi.WithIParamsBehavior=Ext.extend(afStudio.wi.BaseBehavior,{setProperties:function(a){this.properties=a},createBehaviorProperties:function(){return this.properties},configureFor:function(f){if(f["i:params"]){var d=f["i:params"];delete f["i:params"];if(!d["i:param"]){return}if(Ext.isArray(d["i:param"])){d=d["i:param"]}else{d=[d["i:param"]]}var e={};for(var c=0;c<d.length;c++){e[d[c]["name"]]=d[c]["_content"]}for(var c=0;c<this.properties.length;c++){var b=this.properties[c],a=b.id;if(e[a]){b.set("value",e[a])}}}},dumpDataForWidgetDefinition:function(f){var e=[];for(var d=0;d<this.properties.length;d++){var c=this.properties[d],b=c.id,a=c.get("value");if(f[b]){e.push({"name":b,"_content":a})}delete f[b]}f["i:params"]={"i:param":e};return f}});Ext.namespace("afStudio.wi");afStudio.wi.BaseNode=Ext.extend(Ext.tree.TreeNode,{constructor:function(a){a=Ext.apply(a||this.getNodeConfig(),{editable:false});this.createContextMenu();afStudio.wi.BaseNode.superclass.constructor.call(this,a);this._initEvents();this.createProperties();this.addRequiredChilds();this.behaviors=[]},getNodeConfig:Ext.emptyFn,createContextMenu:Ext.emptyFn,_initEvents:function(){if(Ext.isFunction(this.onContextMenuClick)){this.on("contextmenu",this.onContextMenuClick)}},onContextMenuClick:Ext.emptyFn,createProperties:function(){return[]},addRequiredChilds:Ext.emptyFn,getProperties:function(){var a=[];for(i in this.properties){a.push(this.properties[i])}return a},getProperty:function(a){return this.properties[a]},addProperty:function(a){if(!this.properties){this.properties={}}a.WITreeNode=this;this.properties[a.id]=a},addProperties:function(b){for(var a=0;a<b.length;a++){this.addProperty(b[a])}},configureFor:function(c){for(var b in c){this.configureForValue(b,c[b])}for(var a=0;a<this.behaviors.length;a++){this.behaviors[a].configureFor(c)}},configureForValue:function(e,b){if(this.properties&&this.properties[e]){var a=this.getProperty(e);a.set("value",b);this.propertyChanged(a)}else{var d=this.findChild("id",e);if(d){d.configureFor(b)}else{d=this.findChild("childNodeId",e);if(d){var c={};c[e]=b;d.configureFor(c)}}}},propertyChanged:function(b){if(!b){return}for(var a=0;a<this.behaviors.length;a++){this.behaviors[a].propertyChanged(b)}},dumpDataForWidgetDefinition:function(c){if(!c){c={}}var a=this.dumpChildsData();var d=this.dumpPropertiesData();Ext.apply(a,d);for(var b=0;b<this.behaviors.length;b++){a=this.behaviors[b].dumpDataForWidgetDefinition(a)}if(this.id.substr(0,6)=="xnode-"){for(b in a){c[b]=a[b]}}else{c[this.id]=a}return c},dumpChildsData:function(){var a={};this.eachChild(function(b){a=b.dumpDataForWidgetDefinition(a)});return a},dumpPropertiesData:function(){var c={};for(i in this.properties){var b=this.properties[i];var a=b.get("value");if(a===false){a="false"}else{if(a===true){a="true"}}if(!Ext.isEmpty(b.id)){c[b.id]=a}}return c},getPropertyRecordCfg:Ext.emptyFn,addBehavior:function(a){a.setNode(this);this.behaviors.push(a);this.addProperties(a.createBehaviorProperties())}});afStudio.wi.ContainerNode=Ext.extend(afStudio.wi.BaseNode,{});afStudio.wi.CollectionNode=Ext.extend(afStudio.wi.BaseNode,{addChildActionLabel:"Add child",childNodeId:"i:child",dumpEvenWhenEmpty:true,createContextMenu:function(){this.contextMenu=new Ext.menu.Menu({items:[{text:this.addChildActionLabel,iconCls:"icon-add",handler:this.addChild,scope:this}]})},onContextMenuClick:function(a,b){a.select();this.contextMenu.showAt(b.getXY())},addChild:function(){var a=this.createChild();this.appendChild(a);if(this.rendered){this.expand()}return a},configureForValue:function(d,c){if(d==this.childNodeId){if(!Ext.isArray(c)){c=[c]}for(var b=0;b<c.length;b++){var a=this.addChild();a.configureFor(c[b])}}else{afStudio.wi.CollectionNode.superclass.configureForValue.apply(this,arguments)}},dumpChildsData:function(){var b=[],a={};this.eachChild(function(c){b.push(c.dumpDataForWidgetDefinition())});if(b.length==0&&!this.dumpEvenWhenEmpty){return a}a[this.childNodeId]=b;return a},createChild:Ext.emptyFn});afStudio.wi.FieldsNode=Ext.extend(afStudio.wi.CollectionNode,{constructor:function(a){this.childIdsOrdered=[];afStudio.wi.FieldsNode.superclass.constructor.apply(this,arguments)},addChild:function(){var a=afStudio.wi.FieldsNode.superclass.addChild.apply(this,arguments);this.childIdsOrdered.push(a.id);return a},dumpChildsData:function(){var c=[],d=[],a={};for(var b=0;b<this.childIdsOrdered.length;b++){var e=this.findChild("id",this.childIdsOrdered[b]);d.push(e)}for(var b=0;b<d.length;b++){c.push(d[b].dumpDataForWidgetDefinition())}if(c.length==0&&!this.dumpEvenWhenEmpty){return a}a[this.childNodeId]=c;return a},setChildsOrder:function(a){this.childIdsOrdered=a}});afStudio.wi.NodeBuilder={createContainerNode:function(a,b){if(!b){b=afStudio.wi.ContainerNode}var c=Ext.extend(b,{});var d=c.prototype;d.getNodeConfig=function(){var e={};if(a.id){e.id=a.id}if(a.text){e.text=a.text}if(a.iconCls){e.iconCls=a.iconCls}return e};if(a.createProperties){d.createProperties=function(){var e=a.createProperties();this.addProperties(e)}}if(a.createRequiredChilds){d.addRequiredChilds=function(){var f=a.createRequiredChilds();for(var e=0;e<f.length;e++){this.appendChild(f[e])}}}return c},createCollectionNode:function(a,b){var c=this.createContainerNode(a,(b?b:afStudio.wi.CollectionNode));var d=c.prototype;if(a.addChildActionLabel){d.addChildActionLabel=a.addChildActionLabel}if(a.childNodeId){d.childNodeId=a.childNodeId}if(Ext.isDefined(a.dumpEvenWhenEmpty)){d.dumpEvenWhenEmpty=a.dumpEvenWhenEmpty}if(a.createChildConstructor){d.createChild=function(){return new a.createChildConstructor}}return c}};afStudio.wi.ValidatorsNode=Ext.extend(afStudio.wi.CollectionNode,{addChildActionLabel:"Add Validator",childNodeId:"i:validator",getNodeConfig:function(){return{"text":"Validators","childNodeId":"i:validator"}},createChild:function(){return new afStudio.wi.ValidatorNode()},dumpDataForWidgetDefinition:function(){var a=this.dumpChildsData();var b=this.dumpPropertiesData();for(key in b){if(b[key]!=""){a[key]=b[key]}}for(i=0;i<this.behaviors.length;i++){a=this.behaviors[i].dumpDataForWidgetDefinition(this,a)}return a}});afStudio.wi.FieldNode=Ext.extend(afStudio.wi.ContainerNode,{constructor:function(){afStudio.wi.FieldNode.superclass.constructor.apply(this,arguments);var a=new afStudio.wi.WithValueTypeBehavior;a.setValueTypeDataKey("i:value");this.addBehavior(a);this.addBehavior(new afStudio.wi.WithNamePropertyAsLabelBehavior)},getNodeConfig:function(){return{"text":"new field","iconCls":"icon-field"}},createProperties:function(){var a=[new afStudio.wi.PropertyTypeString("name","Name").setRequired().create(),new afStudio.wi.PropertyTypeString("label","Label").create(),new afStudio.wi.FieldType().create(),new afStudio.wi.PropertyTypeString("state","State").create(),new afStudio.wi.PropertyTypeString("style","Style").create(),];this.addProperties(a)},addRequiredChilds:function(){this.validatorsNode=new afStudio.wi.ValidatorsNode;this.appendChild(this.validatorsNode)},setNameAndLabel:function(b,a){this.properties["name"].set("value",b);this.properties["label"].set("value",a)},setTypeAndValidatorFromModelType:function(a){this.setTypeFromModelType(a.type);if(a.required){var b=this.validatorsNode.addChild();b.getProperty("name").set("value","immValidatorRequired")}},setTypeFromModelType:function(a){var b="";if(a.substr(0,7)=="varchar"){a="varchar"}switch(a){case"integer":b="input";break;case"varchar":b="input";break;case"longvarchar":b="textarea";break;case"timestamp":b="input";break;case"boolean":b="checkbox";break;default:break}this.properties["type"].set("value",b)}});afStudio.wi.ValidatorNode=Ext.extend(afStudio.wi.CollectionNode,{addChildActionLabel:"Add Parameter",childNodeId:"i:param",constructor:function(){afStudio.wi.ValidatorNode.superclass.constructor.apply(this,arguments);this.addBehavior(new afStudio.wi.WithNamePropertyAsLabelBehavior)},getNodeConfig:function(){return{"text":"Validator"}},createChild:function(){return new afStudio.wi.ParamNode()},createProperties:function(){var a=[new afStudio.wi.PropertyTypeString("name","Name").setRequired().create()];this.addProperties(a)}});afStudio.wi.ParamNode=Ext.extend(afStudio.wi.ContainerNode,{constructor:function(){afStudio.wi.ParamNode.superclass.constructor.apply(this,arguments);this.addBehavior(new afStudio.wi.WithNamePropertyAsLabelBehavior)},getNodeConfig:function(){return{"text":"parameter"}},createProperties:function(){var a=[new afStudio.wi.PropertyTypeString("name","Name").setRequired().create(),new afStudio.wi.PropertyTypeString("_content","Value").setRequired().create()];this.addProperties(a)}});afStudio.wi.FieldNodeValueSourceBase=Ext.extend(afStudio.wi.ContainerNode,{getNodeConfig:function(){return{"text":"Value Source"}}});afStudio.wi.FieldNodeValueSourceSource=Ext.extend(afStudio.wi.FieldNodeValueSourceBase,{createProperties:function(){this.addProperty(new afStudio.wi.PropertyTypeString("sourceName","Name").setRequired().create())}});afStudio.wi.FieldNodeValueSourceMethod=Ext.extend(afStudio.wi.CollectionNode,{addChildActionLabel:"Add Param",childNodeId:"i:param",getNodeConfig:function(){return{"text":"Value Source"}},createChild:function(){return new afStudio.wi.ParamNode()},createProperties:function(){this.addProperty(new afStudio.wi.PropertyTypeString("i:class","Class").setRequired().create());this.addProperty(new afStudio.wi.PropertyTypeString("i:method","Method").setRequired().create())},configureFor:function(d){if(d["i:method"]){var c=d["i:method"];if(c["i:param"]){var a=c["i:param"]}var b=c["name"];d["i:method"]=b;if(a){d["i:param"]=a}}afStudio.wi.FieldNodeValueSourceMethod.superclass.configureFor.apply(this,[d])}});afStudio.wi.FieldNodeValueSourceItem=Ext.extend(afStudio.wi.FieldNodeValueSourceBase,{createProperties:function(){this.addProperty(new afStudio.wi.PropertyTypeString("i:item","Item").setRequired().create())}});afStudio.wi.FieldNodeValueSourceStatic=Ext.extend(afStudio.wi.FieldNodeValueSourceBase,{createProperties:function(){this.addProperty(new afStudio.wi.PropertyTypeString("i:static","Callback function").setRequired().create())}});afStudio.wi.ActionNode=Ext.extend(afStudio.wi.ContainerNode,{constructor:function(){afStudio.wi.ActionNode.superclass.constructor.apply(this,arguments);this.addBehavior(new afStudio.wi.WithNamePropertyAsLabelBehavior)},getNodeConfig:function(){return{"text":"new action"}},createProperties:function(){var a=[new afStudio.wi.PropertyTypeString("name","Name").setRequired().create(),new afStudio.wi.PropertyTypeString("url","Url").setRequired().create(),new afStudio.wi.PropertyTypeString("iconCls","Icon CSS class").create(),new afStudio.wi.PropertyTypeString("icon","Icon URL").create(),new afStudio.wi.PropertyTypeBoolean("forceSelection","Force selection").create(),new afStudio.wi.PropertyTypeBoolean("post","Post").create(),new afStudio.wi.PropertyTypeString("tooltip","Tooltip").create(),new afStudio.wi.PropertyTypeString("confirmMsg","Confirm message").create(),new afStudio.wi.PropertyTypeString("condition","Condition").create()];this.addProperties(a)}});afStudio.wi.ColumnNode=Ext.extend(afStudio.wi.ContainerNode,{constructor:function(){afStudio.wi.ColumnNode.superclass.constructor.apply(this,arguments);this.initBehavior()},getNodeConfig:function(){return{"text":"new column","iconCls":"icon-field"}},createProperties:function(){var a=[new afStudio.wi.PropertyTypeString("name","Name").setRequired().create(),new afStudio.wi.PropertyTypeBoolean("sortable","Sortable").create(),new afStudio.wi.PropertyTypeBoolean("editable","Editable").create(),new afStudio.wi.PropertyTypeBoolean("resizable","Resizable").create(),new afStudio.wi.PropertyTypeString("style","Style").create(),new afStudio.wi.PropertyTypeString("label","Label").setRequired().create(),new afStudio.wi.PropertyTypeString("filter","Filter").create()];this.addProperties(a)},setNameAndLabel:function(b,a){this.properties["name"].set("value",b);this.properties["label"].set("value",a)},initBehavior:function(){var a=new afStudio.wi.WithValueTypeBehavior;a.setValueTypeDataKey("i:value");this.addBehavior(a);this.addBehavior(new afStudio.wi.WithNamePropertyAsLabelBehavior)}});afStudio.wi.DatasourceNode=Ext.extend(afStudio.wi.ContainerNode,{constructor:function(){afStudio.wi.DatasourceNode.superclass.constructor.apply(this,arguments);this.addBehavior(new afStudio.wi.WithValueTypeBehavior)},getNodeConfig:function(){return{id:"i:datasource",text:"Datasource"}},createProperties:function(){var a=[new afStudio.wi.PropertyTypeString("modelName","Model Name").create()];this.addProperties(a)},setClassFromModel:function(a,c){if(c=="list"){this.properties["modelName"].set("value",a);this.behaviors[0].configureFor(this,{"type":"orm","i:class":"ModelCriteriaFetcher","i:method":{"name":"getDataForList","i:param":[{name:"modelName",_content:a}]}})}else{var b=a+"Peer";this.behaviors[0].configureFor(this,{"type":"orm","i:class":b,"i:method":{"name":"retrieveByPk","i:param":{name:"id",_content:"{id}"}}})}}});Ext.ns("afStudio.wi");afStudio.wi.PropertyRecord=Ext.data.Record.create([{name:"name",type:"string"},"value","required"]);afStudio.wi.PropertyStore=Ext.extend(Ext.grid.PropertyStore,{constructor:function(a,b){afStudio.wi.PropertyStore.superclass.constructor.call(this);this.grid=a;this.store=new Ext.data.GroupingStore({recordType:afStudio.wi.PropertyRecord,groupField:"required"});this.store.on("update",this.onUpdate,this);if(b){this.setSource(b)}},setSource:function(a){this.source=a;this.store.removeAll();this.store.loadRecords({records:a},{},true)}});afStudio.wi.PropertyColumnModel=Ext.extend(Ext.grid.PropertyColumnModel,{constructor:function(c,b){var d=Ext.grid,e=Ext.form;this.grid=c;d.PropertyColumnModel.superclass.constructor.call(this,[{header:this.nameText,id:"name",dataIndex:"name",width:50,sortable:true,menuDisabled:true},{header:this.valueText,id:"value",dataIndex:"value",width:50,resizable:false,menuDisabled:true},{header:"RequiredHeader",id:"required",dataIndex:"required",width:50,resizable:false,menuDisabled:true,hidden:true}]);this.store=b;var a=new e.Field({autoCreate:{tag:"select",children:[{tag:"option",value:"true",html:this.trueText},{tag:"option",value:"false",html:this.falseText}]},getValue:function(){return this.el.dom.value=="true"}});this.editors={"date":new d.GridEditor(new e.DateField({selectOnFocus:true})),"string":new d.GridEditor(new e.TextField({selectOnFocus:true})),"number":new d.GridEditor(new e.NumberField({selectOnFocus:true,style:"text-align:left;"})),"boolean":new d.GridEditor(a,{autoSize:"both"})};this.renderCellDelegate=this.renderCell.createDelegate(this);this.renderPropDelegate=this.renderProp.createDelegate(this)},getCellEditor:function(a,e){var b=this.store.getProperty(e),d=b.id,c=b.data.value;if(this.grid.customEditors[d]){return this.grid.customEditors[d]}if(Ext.isDate(c)){return this.editors.date}else{if(typeof c=="number"){return this.editors.number}else{if(typeof c=="boolean"){return this.editors["boolean"]}else{return this.editors.string}}}}});afStudio.wi.PropertyGrid=Ext.extend(Ext.grid.EditorGridPanel,{enableColumnMove:false,stripeRows:false,trackMouseOver:false,clicksToEdit:1,enableHdMenu:false,viewConfig:{forceFit:true},initComponent:function(){this.customRenderers=this.customRenderers||{};this.customEditors=this.customEditors||{};this.lastEditRow=null;var b=new afStudio.wi.PropertyStore(this);this.propStore=b;var a=new afStudio.wi.PropertyColumnModel(this,b);b.store.sort("name","ASC");this.addEvents("beforepropertychange","propertychange");this.cm=a;this.ds=b.store;afStudio.wi.PropertyGrid.superclass.initComponent.call(this);this.mon(this.selModel,"beforecellselect",function(e,d,c){if(c===0){this.startEditing.defer(200,this,[d,1]);return false}},this)},onRender:function(){Ext.grid.PropertyGrid.superclass.onRender.apply(this,arguments);this.getGridEl().addClass("x-props-grid")},afterRender:function(){afStudio.wi.PropertyGrid.superclass.afterRender.apply(this,arguments);if(this.source){this.setSource(this.source)}},setSource:function(a){this.addCustomEditorsAndRenderers(a);this.propStore.setSource(a);this.hideMandatoryCheckers()},addCustomEditorsAndRenderers:function(e){for(var d=0,a=e.length;d<a;d++){if("choice"==e[d].type){if(!this.customEditors[e[d].id]){var b=[];for(var c in e[d].originalStore){b.push([c,e[d].originalStore[c]])}this.customEditors[e[d].id]=new Ext.grid.GridEditor(new Ext.form.ComboBox({selectOnFocus:true,value:e[d].get("value"),tpl:'<tpl for="."><div ext:qtip="{field2}" class="x-combo-list-item">{field2}</div></tpl>',store:b,triggerAction:"all"}))}if(!this.customRenderers[e[d].id]){this.customRenderers[e[d].id]=function(f,h,g){return g.originalStore[f]}}}}},hideMandatoryCheckers:function(){var a=Ext.select('div[id*="-gp-required-Mandatory-hd"]');if(a){a.setStyle({display:"none"})}},getSource:function(){return this.propStore.getSource()}});Ext.reg("afStudio.wi.propertyGrid",afStudio.wi.PropertyGrid);Ext.ns("afStudio.wi");afStudio.wi.PropertyBaseType=function(a,b){this.id=a;this.label=b};Ext.apply(afStudio.wi.PropertyBaseType.prototype,{defaultValue:"",type:"string",required:false,setRequired:function(){this.required=true;return this},setValue:function(a){this.value=a;return this},create:function(){var a=Ext.data.Record.create([{name:"name",type:"string"},{name:"value",type:this.type},"required"]);var b=new a({name:this.label,value:this.value||this.defaultValue,required:this.required?"Mandatory":"Optional"},this.id);b.type=this.type;b.originalStore=this.store;return b}});afStudio.wi.PropertyTypeBoolean=Ext.extend(afStudio.wi.PropertyBaseType,{type:"boolean",defaultValue:false});afStudio.wi.PropertyTypeChoice=Ext.extend(afStudio.wi.PropertyBaseType,{type:"choice",defaultValue:"",setChoices:function(a){this.store=a;return this}});afStudio.wi.PropertyTypeString=Ext.extend(afStudio.wi.PropertyBaseType,{type:"string",defaultValue:""});afStudio.wi.ValueSource=Ext.extend(afStudio.wi.PropertyTypeChoice,{defaultValue:"",constructor:function(){afStudio.wi.ValueSource.superclass.constructor.apply(this,["valueSource","Value Source"]);this.setChoices({"source":"source","classAndMethod":"class and method","static":"static","file":"file"});this.setRequired()}});afStudio.wi.ValueType=Ext.extend(afStudio.wi.PropertyTypeChoice,{defaultValue:"",constructor:function(){afStudio.wi.ValueType.superclass.constructor.apply(this,["valueType","Value Type"]);this.setChoices({"default":"&#x20;","orm":"orm","static":"static","file":"file"});this.setRequired()}});afStudio.wi.FieldType=Ext.extend(afStudio.wi.PropertyTypeChoice,{defaultValue:"",constructor:function(){afStudio.wi.FieldType.superclass.constructor.apply(this,["type","Type"]);this.setChoices({"input":"input","textarea":"textarea","checkbox":"checkbox","hidden":"hidden","password":"password","radio":"radio","file":"file","combo":"combo","multicombo":"multicombo"})}});afStudio.wi.ObjectRootNode=Ext.extend(afStudio.wi.BaseNode,{getFieldsNode:function(){return this.fieldsNode},getDatasourceNode:function(){return this.datasourceNode},setTitle:function(a){this.getProperty("i:title").set("value",a)},getNodeConfig:function(){var a={text:"Abstract root Object node",iconCls:"icon-obj",expanded:true};return a},createProperties:function(){this.addProperty(new afStudio.wi.PropertyTypeString("i:title","Title").create());this.addProperty(new afStudio.wi.PropertyTypeString("i:description","Description").create())},addRequiredChilds:function(){this.fieldsNode=this.buildFieldsNode();this.datasourceNode=new afStudio.wi.DatasourceNode();this.appendChild(this.datasourceNode);this.appendChild(this.fieldsNode)},buildFieldsNode:Ext.emptyFn});afStudio.wi.EditNode=Ext.extend(afStudio.wi.ObjectRootNode,{widgetType:"edit",getNodeConfig:function(){var a={text:"New edit widget"};return a},buildFieldsNode:function(){var a=afStudio.wi.NodeBuilder.createCollectionNode({text:"Fields",id:"i:fields",createChildConstructor:afStudio.wi.FieldNode,childNodeId:"i:field",addChildActionLabel:"Add field",createProperties:function(){return[new afStudio.wi.PropertyTypeString("url","Url").setRequired().create()]}},afStudio.wi.FieldsNode);return new a}});afStudio.wi.ListNode=Ext.extend(afStudio.wi.ObjectRootNode,{widgetType:"list",getNodeConfig:function(){var a={text:"New list widget"};return a},constructor:function(){afStudio.wi.ListNode.superclass.constructor.apply(this,arguments);var a=new afStudio.wi.WithIParamsBehavior();a.setProperties([new afStudio.wi.PropertyTypeString("maxperpage","Max records per page").setValue(10).create()]);this.addBehavior(a)},addRequiredChilds:function(){afStudio.wi.ListNode.superclass.addRequiredChilds.apply(this);var a=[];a.push(this.buildActionsNode(afStudio.wi.ActionNode));a.push(this.buildRowactionsNode(afStudio.wi.ActionNode));a.push(this.buildMoreactionsNode(afStudio.wi.ActionNode));a.push(this.buildProxyNode());this.appendChild(a)},buildFieldsNode:function(){var a=afStudio.wi.NodeBuilder.createCollectionNode({id:"i:fields",text:"Fields",createChildConstructor:afStudio.wi.ColumnNode,childNodeId:"i:column",addChildActionLabel:"Add column"},afStudio.wi.FieldsNode);return new a},buildProxyNode:function(){var a=afStudio.wi.NodeBuilder.createContainerNode({text:"Proxy",id:"i:proxy",createProperties:function(){return[new afStudio.wi.PropertyTypeString("url","Url").setRequired().create()]}});return new a},buildActionsNode:function(b){var a=afStudio.wi.NodeBuilder.createCollectionNode({id:"i:actions",text:"Actions",createChildConstructor:b,childNodeId:"i:action",addChildActionLabel:"Add action",dumpEvenWhenEmpty:false});return new a},buildRowactionsNode:function(b){var a=afStudio.wi.NodeBuilder.createCollectionNode({id:"i:rowactions",text:"Row Actions",createChildConstructor:b,childNodeId:"i:action",addChildActionLabel:"Add row action",dumpEvenWhenEmpty:false});return new a},buildMoreactionsNode:function(b){var a=afStudio.wi.NodeBuilder.createCollectionNode({id:"i:moreactions",text:"More Actions",createChildConstructor:b,childNodeId:"i:action",addChildActionLabel:'Add "more action"',dumpEvenWhenEmpty:false});return new a}});Ext.namespace("afStudio.wi");afStudio.wi.WidgetInspectorTree=Ext.extend(Ext.tree.TreePanel,{layout:"fit",_beforeInitComponent:function(){var b=this;var a=this.createRootNode();this.treeSorter=new Ext.tree.TreeSorter(this,{folderSort:true});return{root:a,animate:true,containerScroll:true,autoScroll:true}},initComponent:function(){Ext.apply(this,Ext.apply(this.initialConfig,this._beforeInitComponent()));afStudio.wi.WidgetInspectorTree.superclass.initComponent.apply(this,arguments);this._afterInitComponent()},_afterInitComponent:function(){var a=this;this.on({scope:a,afterrender:a.initWidgetInspectorTree})},initWidgetInspectorTree:function(){this.expandAll()},createRootNode:function(){var b=this.widgetMeta.widgetUri,c=this.widgetMeta.definition,a=afStudio.wd.WidgetFactory.createWIRootNode(c.type);a.setText(b+" ["+c.type+"]");a.configureFor(c);return a}});Ext.reg("afStudio.wi.widgetInspectorTree",afStudio.wi.WidgetInspectorTree);Ext.namespace("afStudio.wi");afStudio.wi.InspectorPanel=Ext.extend(Ext.Panel,{layout:"border",_beforeInitComponent:function(){var a=this;return{title:"Widget Inspector",items:[{xtype:"afStudio.wi.widgetInspectorTree",ref:"inspectorTree",region:"center",widgetMeta:this.widgetMeta},{xtype:"afStudio.wi.propertyGrid",ref:"propertyGrid",region:"south",split:true,height:150,layout:"fit",view:new Ext.grid.GroupingView({scrollOffset:19,forceFit:true,showGroupName:false,groupTextTpl:"{text}"})}]}},initComponent:function(){Ext.apply(this,Ext.apply(this.initialConfig,this._beforeInitComponent()));afStudio.wi.InspectorPanel.superclass.initComponent.apply(this,arguments);this._afterInitComponent()},_afterInitComponent:function(){var a=this;this.inspectorTree.on({scope:a,click:a.onInspectorTreeNodeClick});this.propertyGrid.on({scope:a,afteredit:a.onPropertyGridAfterEdit});this.propertyGrid.getView().on("refresh",a.onGridRefresh,a)},onInspectorTreeNodeClick:function(b,c){var a=b.getProperties();this.propertyGrid.setSource(a)},onPropertyGridAfterEdit:function(a){this.onGridRefresh(a.grid.getView());if(a.record&&a.record.WITreeNode){a.record.WITreeNode.propertyChanged(a.record)}},onGridRefresh:function(m){var a=m.grid,b=a.getStore();for(var g=0,l=b.getCount();g<l;g++){var c=b.getAt(g);var h="<b>"+c.get("name")+":</b> "+c.get("value");var n=m.getRow(g);var f=Ext.get(n).select(".x-grid3-cell-inner");for(var e=0,d=f.getCount();e<d;e++){Ext.QuickTips.register({target:f.item(e),text:h})}}a.hideMandatoryCheckers()}});Ext.reg("afStudio.wi.inspectorPanel",afStudio.wi.InspectorPanel);Ext.namespace("afStudio.wi");afStudio.wi.InspectorPalette=Ext.extend(Ext.Container,{layout:"accordion",style:"border-top: 1px solid #99BBE8;",_beforeInitComponent:function(){var a=this;return{items:[{xtype:"afStudio.wi.inspectorPanel",ref:"inspectorPanel",widgetMeta:this.widgetMeta},{xtype:"filetreepanel",ref:"codeBrowser",title:"Code Browser",url:afStudioWSUrls.getFiletreeUrl(),rootText:"Home",rootPath:"root",rootVisible:true,maxFileSize:524288*2*10,autoScroll:true,enableProgress:false,singleUpload:true}]}},initComponent:function(){Ext.apply(this,Ext.apply(this.initialConfig,this._beforeInitComponent()));afStudio.wi.InspectorPalette.superclass.initComponent.apply(this,arguments);this._afterInitComponent()},_afterInitComponent:function(){var a=this;this.on({scope:this,afterrender:function(){(function(){var f=this.inspectorPanel.propertyGrid,e=this.inspectorPanel.inspectorTree;var c=f.getHeight(),b=e.getHeight(),d=(c+b)/2;f.setHeight(d);e.setHeight(d);this.layout.setActiveItem(1);this.layout.setActiveItem(0)}).defer(100,this)}})},getPropertyGrid:function(){return this.inspectorPanel.propertyGrid},getInspectorTree:function(){return this.inspectorPanel.inspectorTree}});Ext.reg("afStudio.wi.inspectorPalette",afStudio.wi.InspectorPalette);Ext.ns("afStudio.wd.list");afStudio.wd.list.SimpleListView=Ext.extend(Ext.grid.GridPanel,{columnName:"NewColumn",columnWidth:80,maxColumns:30,_beforeInitComponent:function(){var h=this,e=this.viewMeta,d=[];if(!Ext.isEmpty(e["i:fields"]["i:column"])){var f=e["i:fields"]["i:column"];if(Ext.isArray(f)){for(var b=0;b<f.length;b++){var g=f[b];d.push({header:g.label,name:g.name,width:g.width?g.width:this.columnWidth})}for(var b=d.length-1;b<=this.maxColumns;b++){d.push({header:this.columnName,width:this.columnWidth,hidden:true,uninit:true})}}else{d.push({header:f.label,name:f.name,width:f.width?f.width:this.columnWidth});for(var b=1;b<=this.maxColumns;b++){d.push({header:this.columnName,width:this.columnWidth,hidden:true,uninit:true})}}}var a=new Ext.data.ArrayStore({idIndex:0,data:[[]],fields:[]});return{title:e["i:title"],store:a,columns:d,view:new afStudio.wd.list.ListGridView(),columnLines:true}},initComponent:function(){Ext.apply(this,Ext.apply(this.initialConfig,this._beforeInitComponent()));afStudio.wd.list.SimpleListView.superclass.initComponent.apply(this,arguments);this._afterInitComponent()},_afterInitComponent:function(){var a=this;this.addEvents("changeColumnPosition");this.on({scope:a,columnmove:a.onColumnMove,contextmenu:function(b){b.preventDefault()}})},onColumnMove:function(c,a){if(c!=a){var b=this.getColumnModel().config[a];this.fireEvent("changeColumnPosition",b,c,a)}}});Ext.reg("afStudio.wd.list.simpleListView",afStudio.wd.list.SimpleListView);Ext.ns("afStudio.wd.list");afStudio.wd.list.ListGridView=Ext.extend(Ext.grid.GridView,{invalidColumnName:'Column name must contain only characters, digits or "_" and start from character or "_"',beforeColMenuShow:function(){var b=this.cm,d=b.getColumnCount(),a=this.colMenu,c;a.removeAll();for(c=0;c<d;c++){if(b.config[c].hideable!==false&&!b.config[c].uninit){a.add(new Ext.menu.CheckItem({text:b.getColumnHeader(c),itemId:"col-"+b.getColumnId(c),checked:!b.isHidden(c),disabled:b.config[c].hideable===false,hideOnClick:false}))}}},afterRenderUI:function(){var a=this.grid;this.initElements();Ext.fly(this.innerHd).on("click",this.handleHdDown,this);this.mainHd.on({scope:this,mouseover:this.handleHdOver,mouseout:this.handleHdOut,mousemove:this.handleHdMove});this.scroller.on("scroll",this.syncScroll,this);if(a.enableColumnResize!==false){this.splitZone=new Ext.grid.GridView.SplitDragZone(a,this.mainHd.dom)}if(a.enableColumnMove){this.columnDrag=new Ext.grid.GridView.ColumnDragZone(a,this.innerHd);this.columnDrop=new Ext.grid.HeaderDropZone(a,this.mainHd.dom)}if(a.enableHdMenu!==false){this.hmenu=new Ext.menu.Menu({id:a.id+"-hctx",show:function(c,d,b){this.parentMenu=b;if(!this.el){this.render()}this.fireEvent("beforeshow",this);this._el=c;this.showAt(this.el.getAlignToXY(c,d||this.defaultAlign),b,false)}});this.colMenu=new Ext.menu.Menu({id:a.id+"-hcols-menu"});this.colMenu.on({scope:this,beforeshow:this.beforeColMenuShow,itemclick:this.handleColumnMenuClick});this.hmenu.add({itemId:"addClmBefore",text:"Add Column Before"},{itemId:"addClmAfter",text:"Add Column After"},{itemId:"renameClm",text:"Rename Column"},{itemId:"deleteClm",text:"Delete Column"},"-",{itemId:"columns",text:this.columnsText,menu:this.colMenu,hideOnClick:false,iconCls:"x-cols-icon"});this.hmenu.on("itemclick",this.handleHdMenuClick,this)}if(a.trackMouseOver){this.mainBody.on({scope:this,mouseover:this.onRowOver,mouseout:this.onRowOut})}if(a.enableDragDrop||a.enableDrag){this.dragZone=new Ext.grid.GridDragZone(a,{ddGroup:a.ddGroup||"GridDD"})}this.updateHeaderSortState()},handleColumnMenuClick:function(c){var b=this.hdCtxIndex,a=this.cm,d=this.ds;b=a.getIndexById(c.itemId.substr(4));if(b!=-1){if(c.checked&&a.getColumnsBy(this.isHideableColumn,this).length<=1){this.onDenyColumnHide();return false}a.setHidden(b,c.checked)}return true},getUninitColumn:function(){for(var a=0;a<this.cm.config.length;a++){var b=this.cm.config[a];if(b.uninit){return a}}return 0},handleHdMenuClick:function(e){var b=this.hdCtxIndex,a=this.cm,f=this.ds,d=a.getDataIndex(b);switch(e.itemId){case"addClmAfter":var h=this.getUninitColumn();this.cm.config[h].uninit=false;this.cm.moveColumn(h,b+1);this.cm.setHidden(b+1,false);break;case"addClmBefore":var h=this.getUninitColumn();this.cm.config[h].uninit=false;this.cm.moveColumn(h,b);this.cm.setHidden(b,false);break;case"renameClm":var g=this.findHeaderCell(e.parentMenu._el);this.editHeadColumn(g.firstChild,b);break;case"deleteClm":var c=a.getColumnCount(true);if(c>1){a.setHidden(b,true);a.config[b].uninit=true;a.config[b].header=this.grid.columnName}break}return true},editHeadColumn:function(c,b){var e=this,d=this.cm.getColumnHeader(b);var a=new Ext.grid.GridEditor(new Ext.form.TextField({allowBlank:false,maskRe:/[\w]/,validator:function(f){return/^[^\d]\w*$/im.test(f)?true:e.invalidColumnName}}));a._index=b;a.on("complete",this.onHeadColumnEditComplete,this);a.startEdit(c,d)},onHeadColumnEditComplete:function(d,c,b){var e=d._index,a=this.cm;a.setColumnHeader(e,c)},handleHdDown:function(h,l){var j=this.cm,f=this.findHeaderCell(l),g=this.getCellIndex(f),d=j.isSortable(g),c=this.hmenu,b=c.items,a=this.headerMenuOpenCls;if(Ext.fly(l).hasClass("x-grid3-hd-btn")){h.stopEvent();Ext.fly(f).addClass(a);this.hdCtxIndex=g;c.on("hide",function(){Ext.fly(f).removeClass(a)},this,{single:true});c.show(l,"tl-bl?")}else{this.editHeadColumn(f.firstChild,g)}}});Ext.namespace("afStudio.wd");afStudio.wd.GuiFactory=function(){return{LIST:"list",EDIT:"edit",SHOW:"show",HTML:"html",getWidgetType:function(a){return a.definition?a.definition.type:a.type},isWidgetTypeValid:function(a){return[this.LIST,this.EDIT,this.SHOW,this.HTML].indexOf(a)!=-1?true:false},buildGui:function(c){var a=c.definition.type,b={};switch(a){case this.LIST:b.view=new afStudio.wd.list.SimpleListView({viewMeta:c.definition});b.controls=this.createListViewToolbar();break;case this.EDIT:b.view={xtype:"container",html:"EDIT view <br /> is under construction."};b.controls=this.createEditViewToolbar();break;case this.SHOW:b.view={xtype:"container",html:"SHOW view <br /> is under construction."};b.controls=this.createShowViewToolbar();break;case this.HTML:b.view={xtype:"container",html:"HTML view <br /> is under construction."};b.controls=this.createHtmlViewToolbar();break}return b},createListViewToolbar:function(){return new Array({text:"Add Column",itemId:"addColumnBtn",iconCls:"icon-add"},"-")},createEditViewToolbar:function(){return new Array({text:"Add Field",iconCls:"icon-add"},"-",{text:"Format",iconCls:"icon-format",menu:{ignoreParentClicks:true,items:[{text:"Columns",menu:{items:[{xtype:"combo",triggerAction:"all",mode:"local",emptyText:"Select an item...",store:[[1,"1 columns"],[2,"2 columns"],[3,"3 columns"],[4,"4 columns"]]}]}},{text:"Re-size"}]}},"-")},createShowViewToolbar:function(){return[]},createHtmlViewToolbar:function(){return[]}}}();Ext.namespace("afStudio.wd");afStudio.wd.DesignerPanel=Ext.extend(Ext.Panel,{layout:"fit",_beforeInitComponent:function(){var d=this,b=afStudio.wd.GuiFactory;var a=b.buildGui(this.widgetMeta);var c=[{text:"Save",itemId:"saveBtn",iconCls:"icon-save"},"-",{text:"Preview",itemId:"previewBtn",iconCls:"icon-preview"}];Ext.flatten(c.splice(2,0,a.controls));return{border:true,autoScroll:true,bodyStyle:"padding: 4px;",tbar:new Ext.Toolbar({items:c}),items:[a.view]}},initComponent:function(){Ext.apply(this,Ext.apply(this.initialConfig,this._beforeInitComponent()));afStudio.wd.DesignerPanel.superclass.initComponent.apply(this,arguments)},getDesignerView:function(){return this.items.itemAt(0)},getMenuItem:function(a){return this.getTopToolbar().getComponent(a)}});Ext.reg("afStudio.wd.designerPanel",afStudio.wd.DesignerPanel);Ext.namespace("afStudio.wd");afStudio.wd.DesignerTab=Ext.extend(Ext.Panel,{layout:"hbox",layoutConfig:{align:"stretch",pack:"start"},_beforeInitComponent:function(){return{title:"Widget Designer",defaults:{layout:"fit",style:"padding: 2px;"},items:[{xtype:"afStudio.wd.designerPanel",ref:"designerPanel",widgetMeta:this.widgetMeta,flex:3},{xtype:"container",flex:1,items:[{xtype:"afStudio.wi.inspectorPalette",ref:"../inspectorPalette",widgetMeta:this.widgetMeta}]}]}},initComponent:function(){Ext.apply(this,Ext.apply(this.initialConfig,this._beforeInitComponent()));afStudio.wd.DesignerTab.superclass.initComponent.apply(this,arguments);this._afterInitComponent()},_afterInitComponent:function(){var c=this,a=afStudio.wd.GuiFactory,b=a.getWidgetType(this.widgetMeta);this.designerView=this.designerPanel.getDesignerView();this.viewProperty=this.inspectorPalette.getPropertyGrid();this.viewInspector=this.inspectorPalette.getInspectorTree();this.designerPanel.getMenuItem("saveBtn").on("click",this.onSaveWidgetView,this);this.designerPanel.getMenuItem("previewBtn").on("click",this.onPreviewWidgetView,this);if(a.isWidgetTypeValid(b)){this["init"+b.ucfirst()+"DesignerView"]()}else{afStudio.Msg.error("Widget Designer",String.format("Unknown widget type <b>{0}</b>",b))}c.on({scope:this,afterrender:function(){}})},initListDesignerView:function(){this.relayEvents(this.designerView,["changeColumnPosition"]);this.designerPanel.getMenuItem("addColumnBtn").on("click",function(){afStudio.Msg.info("Add column click")},this);this.on({scope:this,changeColumnPosition:this.onListViewChangeColumnPosition})},initEditDesignerView:function(){},initShowDesignerView:function(){},initHtmlDesignerView:function(){},onSaveWidgetView:function(){var a=this.widgetMeta.widgetUri,d=afStudio.wd.GuiFactory.getWidgetType(this.widgetMeta),e=this.viewInspector,c=e.getRootNode();var f=c.dumpDataForWidgetDefinition();var b=new afStudio.wd.WidgetDefinition({widgetUri:a,widgetType:d});b.saveDefinition(f)},onPreviewWidgetView:function(){var a=this.widgetMeta.widgetUri,b=this.viewInspector.getRootNode();afApp.widgetPopup(a,b.text,null,null,afStudio)},onListViewChangeColumnPosition:function(f,b,c){var a=this.widgetMeta.widgetUri,g=afStudio.wd.GuiFactory.getWidgetType(this.widgetMeta),h=this.viewInspector,e=h.getRootNode(),d=e.getFieldsNode();if(d&&d.findChild("text",f.name)){if(b>c){d.childIdsOrdered.dragUp(b,c)}else{d.childIdsOrdered.dragDown(b,c)}}}});Ext.reg("afStudio.wd.designerTab",afStudio.wd.DesignerTab);Ext.namespace("afStudio.wd");afStudio.wd.CodeEditorTab=Ext.extend(Ext.Panel,{layout:"hbox",layoutConfig:{align:"stretch"},closable:true,_beforeInitComponent:function(){var a=this;a.codePress=new Ext.ux.CodePress({title:this.fileName,path:this.filePath,tabTip:this.tabTip,file:this.file,closable:true,tabPanel:this,ctCls:"codeEditorCls"});a.codeBrowserTree=new Ext.ux.FileTreePanel({title:"Code Browser",flex:1,rootPath:"root",rootVisible:true,rootText:"Home",url:afStudioWSUrls.getFiletreeUrl(),maxFileSize:524288*2*10,topMenu:false,autoScroll:true,enableProgress:false,singleUpload:true});return{title:this.fileName,iconCls:"icon-script-edit",defaults:{style:"padding: 5px;"},tbar:[{text:"Save",itemId:"saveBtn",iconCls:"icon-save"}],items:[{title:"Code Editor",flex:3,layout:"fit",items:[{border:false,layout:"fit",items:a.codePress}]},a.codeBrowserTree]}},initComponent:function(){Ext.apply(this,Ext.apply(this.initialConfig,this._beforeInitComponent()));afStudio.wd.CodeEditorTab.superclass.initComponent.apply(this,arguments);this._afterInitComponent()},_afterInitComponent:function(){var b=this,a=this.getTopToolbar().getComponent("saveBtn");a.on("click",b.onCodeSaveClick,b)},onCodeSaveClick:function(){var a=this;Ext.Ajax.request({url:a.codePress.fileContentUrl,params:{"file":a.codePress.file,"code":a.codePress.getCode()},success:function(b,c){a.fireEvent("logmessage",a,"Widget Designer code Saved");afStudio.Msg.info(String.format("File <u>{0}</u> was successfully saved.",a.codePress.title))},failure:function(d,c){var b=String.format("Status code: {0}, message: {1}",d.status,d.statusText);afStudio.Msg.error("Server side error",b)}})}});Ext.reg("afStudio.wd.codeEditorTab",afStudio.wd.CodeEditorTab);Ext.override(Ext.grid.GridDragZone,{afterRepair:function(){Ext.fly(this.DDM.currentTarget).parent("TABLE").frame("#FFA7A7",1);this.dragging=false}});Ext.ns("afStudio.wd");afStudio.wd.WidgetsBuilder=Ext.extend(Ext.Window,{onWndShow:function(){var d=this;var a=this.relationsGrid.getView().scroller.dom;new Ext.dd.DropTarget(a,{ddGroup:"widgetsBuilder",notifyDrop:function(p,o,l){var h=p.dragData.selections;var g=d.fieldsGrid.getSelectionModel().getSelected();var n=d.modelsTree.getSelectionModel().getSelectedNode();var f=d.modelsTree.getModel(n);if(g){Ext.each(h,p.grid.store.remove,p.grid.store);var j=new d.RelationRec({id:g.get("id"),model:f,name:f+"."+g.get("name"),field:g.get("name"),type:g.get("type"),size:g.get("size"),required:g.get("required")});d.relationsGrid.store.add(j);d.relationsGrid.store.sort("name","ASC");return true}else{this.dragging=false}}});var c=Ext.getCmp("widgets-basket");var b=c.body.dom;new Ext.dd.DropTarget(b,{ddGroup:"widgetsBuilderRel",notifyEnter:function(j,h,f){c.body.stopFx();var g=f.grid.getId();if("fields-grid"==g){return this.dropNotAllowed}else{c.body.highlight("#E56060");return this.dropAllowed}},notifyDrop:function(l,j,g){var h=g.grid.getId();if("fields-grid"==h){Ext.fly(this.DDM.currentTarget).parent("TABLE").frame("#8db2e3",1);this.dragging=false;return false}else{var f=l.dragData.selections[0];l.grid.store.remove(f);return true}}})},loadModelFields:function(b,d){var c=this.modelsTree.getSchema(b),a=this.modelsTree.getModel(b);this.fieldsGrid.getStore().load({params:{schema:c,model:a},callback:d||Ext.emptyFn})},onModelClick:function(a,b){this.fieldsGrid.show();this.loadModelFields(a)},onModelsLoad:function(a,b){this.fieldsGrid.getStore().removeAll();this.fieldsGrid.hide()},onRelGridRefresh:function(m){var a=m.grid;var b=a.getStore();for(var g=0,l=b.getCount();g<l;g++){var c=b.getAt(g);var h="<b>Field Specification</b><br>";h+="<br><b>Model: </b>"+c.get("model");h+="<br><b>Field: </b>"+c.get("field");if(type=c.get("type")){h+="<br><b>Type: </b>"+type}if(size=c.get("size")){h+="<br><b>Size: </b>"+size}var n=m.getRow(g);var f=Ext.get(n).select(".x-grid3-cell-inner");for(var e=0,d=f.getCount();e<d;e++){Ext.QuickTips.register({target:f.item(e),text:h})}}},_beforeInitComponent:function(){var a=this;this.RelationRec=Ext.data.Record.create(["id","model","name","field","type","size"]);this.relationsGrid=new Ext.grid.GridPanel({id:"rel-grid",flex:1,width:234,ddGroup:"widgetsBuilderRel",enableDragDrop:true,store:new Ext.data.ArrayStore({idIndex:0,fields:["id","model","name","field","type","size"]}),viewConfig:{scrollOffset:19,forceFit:true},columns:[{header:"Selected fields",sortable:true,width:170,dataIndex:"name"}],loadMask:true,border:true,style:"padding-bottom: 5px;",autoScroll:true});this.fieldsGrid=new Ext.grid.GridPanel({id:"fields-grid",ref:"../fieldsGrid",ddGroup:"widgetsBuilder",enableDragDrop:true,store:new Ext.data.JsonStore({url:a.fieldsUrl,autoLoad:false,baseParams:{xaction:"read"},root:"rows",idProperty:"id",fields:["id","name","type","size","required"]}),sm:new Ext.grid.RowSelectionModel({singleSelect:true}),columns:[{header:"Name",sortable:true,width:150,dataIndex:"name"},{header:"Type",sortable:true,width:110,dataIndex:"type"},{header:"Size",sortable:true,width:60,dataIndex:"size"}],loadMask:true,border:false,autoScroll:true,hidden:true});this.basket=new Ext.Panel({id:"widgets-basket",xtype:"panel",html:"<center><br>Drop Item here,<br> to remove it</br></center>",bodyStyle:"padding: 5px;",height:70,width:234});this.modulesCombo=new Ext.ux.form.GroupingComboBox({fieldLabel:"Module Location",loadingText:"Please wait...",emptyText:"Please select the module location...",store:new Ext.data.JsonStore({url:afStudioWSUrls.getModulesUrl(),baseParams:{cmd:"getGrouped"},totalProperty:"total",idProperty:"value",fields:["value","text","group"],remoteSort:true}),displayField:"text",groupField:"group",anchor:"100%",minChars:0,hiddenName:"model"});this.actionInput=new Ext.form.TextField({fieldLabel:"Widget Name",anchor:"100%"});this.typeCombo=new Ext.form.ComboBox({fieldLabel:"Widget Type",triggerAction:"all",anchor:"100%",store:[["list","List"],["grid","Grid"],["edit","Edit"],["show","Show"]],value:"list"});return{title:"Create new widget",y:150,width:450,height:150,modal:true,tbar:{xtype:"toolbar",id:this.id+"help-toolbar",hidden:true,items:["Please select the fields for each model you want to have displayed in your Widget. And drag each field to the Selected fields area."]},layout:"card",activeItem:0,items:[{border:false,bodyBorder:false,hideBorders:true,items:[new Ext.FormPanel({bodyStyle:"padding: 5px;",labelWidth:100,items:[this.modulesCombo,this.actionInput,this.typeCombo]})]},{border:false,bodyBorder:false,xtype:"panel",layout:"border",items:[{region:"west",layout:"fit",margins:"5 5 5 5",width:220,items:[{xtype:"afStudio.models.modelTree",url:a.modelsUrl,border:false,ref:"../../modelsTree"}]},{region:"center",margins:"5 5 5 0",layout:"fit",items:this.fieldsGrid},{region:"east",margins:"5 5 5 0",width:235,layout:"vbox",border:false,bodyBorder:false,bodyStyle:"background-color: #DFE8F6",items:[this.relationsGrid,this.basket]}]}],buttonAlign:"left",buttons:[{text:"Cancel",handler:this.cancel,scope:this},"->",{text:"&laquo; Back",id:this.id+"-back-btn",handler:this.chStep.createDelegate(a,[0]),disabled:true},{text:"Next &raquo;",id:this.id+"-next-btn",handler:this.chStep.createDelegate(a,[1])},{text:"Save &raquo;",id:this.id+"-save-btn",hidden:true,handler:this.create,scope:this}]}},initComponent:function(){Ext.apply(this,Ext.apply(this.initialConfig,this._beforeInitComponent()));afStudio.wd.WidgetsBuilder.superclass.initComponent.apply(this,arguments);this._afterInitComponent()},_afterInitComponent:function(){this.addEvents("widgetcreated");this.on("show",this.onWndShow,this);this.relationsGrid.getView().on("refresh",this.onRelGridRefresh);this.modelsTree.on({"click":Ext.util.Functions.createDelegate(this.onModelClick,this),"modelsload":Ext.util.Functions.createDelegate(this.onModelsLoad,this)})},chStep:function(c){var a=Ext.getCmp(this.id);if(1==c){var b={width:840,height:450};Ext.getCmp(this.id+"-save-btn").show();Ext.getCmp(this.id+"-next-btn").hide();Ext.getCmp(this.id+"-back-btn").enable();Ext.getCmp(this.id+"help-toolbar").show()}else{var b={width:450,height:150};Ext.getCmp(this.id+"-save-btn").hide();Ext.getCmp(this.id+"-next-btn").show();Ext.getCmp(this.id+"-back-btn").disable();Ext.getCmp(this.id+"help-toolbar").hide()}this.setSize(b);this.setPagePosition((Ext.getBody().getWidth()-b.width)/2,150);a.getLayout().setActiveItem(c)},create:function(){var b=[];this.relationsGrid.getStore().each(function(j){if(j.data){b.push(j.data)}});var d=this.modulesCombo.getValue(),f=this.actionInput.getValue(),a=d+"/"+f,e=this.typeCombo.getValue();var c=afStudio.wd.WidgetFactory.buildWidgetDefinition(b,e);var g=new afStudio.wd.WidgetDefinition({widgetUri:a,widgetType:e});var h=Ext.util.Functions.createDelegate(function(j){this.fireEvent("widgetcreated",a,j);this.close()},this);g.saveDefinition(c,h,true)},cancel:function(){this.close()}});Ext.namespace("afStudio.wd");afStudio.wd.WidgetFactory=function(){return{createWIRootNode:function(b){var a;switch(b){case"list":a=new afStudio.wi.ListNode();break;case"edit":a=new afStudio.wi.EditNode();break}return a},buildWidgetDefinition:function(c,b){var a=this.createWIRootNode(b);a.setTitle("new widget");for(k=0;k<c.length;k++){var e=a.getFieldsNode().addChild();e.setNameAndLabel(c[k].field,c[k].field.ucfirst());if(b=="edit"){e.setTypeAndValidatorFromModelType(c[k]);e.getProperty("valueType").set("value","orm")}}if(c.length>0){var d=c[0].model;a.getDatasourceNode().setClassFromModel(d,b)}return a.dumpDataForWidgetDefinition()},showWidgetDesigner:function(a,b,c){afStudio.vp.addToPortal({xtype:"afStudio.wd.widgetPanel",actionPath:b,securityPath:c,widgetUri:a},true)}}}();Ext.namespace("afStudio.wd");afStudio.wd.WidgetTabPanel=Ext.extend(Ext.TabPanel,{_beforeInitComponent:function(){var a=this;this.widgetPanel=this.ownerCt;return{itemId:"widget-designer",border:false,activeTab:0,items:[{xtype:"afStudio.wd.designerTab",widgetMeta:this.widgetMeta},{xtype:"afStudio.wd.codeEditorTab",fileName:"security.yml",filePath:this.widgetMeta.securityPath,tabTip:this.widgetMeta.securityPath,file:this.widgetMeta.securityPath},{xtype:"afStudio.wd.codeEditorTab",fileName:"actions.class.php",filePath:this.widgetMeta.actionPath,tabTip:this.widgetMeta.actionPath,file:this.widgetMeta.actionPath}],plugins:new Ext.ux.TabMenu()}},initComponent:function(){Ext.apply(this,Ext.apply(this.initialConfig,this._beforeInitComponent()));afStudio.wd.WidgetTabPanel.superclass.initComponent.apply(this,arguments);this._afterInitComponent()},_afterInitComponent:function(){var a=this;this.on("beforetabchange",function(c,d,b){if(b&&b.iframe){b.toggleIframe()}if(d&&d.iframe){d.toggleIframe()}},this)},addCodeEditorTab:function(e,d,a,c){var b=this.add({xtype:"afStudio.wd.codeEditorTab",fileName:e,filePath:d,tabTip:a,file:c});this.setActiveTab(b.getId())}});Ext.reg("afStudio.wd.widgetTabPanel",afStudio.wd.WidgetTabPanel);Ext.namespace("afStudio.wd");afStudio.wd.WidgetPanel=Ext.extend(Ext.Panel,{layout:"fit",constructor:function(a){a=a||{};a.widgetMetaData={};if(a.actionPath){a.widgetMetaData.actionPath=a.actionPath;delete a.actionPath}if(a.securityPath){a.widgetMetaData.securityPath=a.securityPath;delete a.securityPath}if(a.widgetUri){a.widgetMetaData.widgetUri=a.widgetUri;delete a.widgetUri}Ext.apply(a,{title:a.widgetMetaData.widgetUri});this.widgetDefinition=new afStudio.wd.WidgetDefinition({widgetUri:a.widgetMetaData.widgetUri});afStudio.wd.WidgetPanel.superclass.constructor.call(this,a)},initComponent:function(){afStudio.wd.WidgetPanel.superclass.initComponent.apply(this,arguments);this._afterInitComponent()},_afterInitComponent:function(){var a=this;this.on({scope:a,afterrender:a.initWidgetPanel})},initWidgetPanel:function(){afStudio.vp.mask({region:"center"});this.widgetDefinition.fetchDefinition({scope:this,success:function(a){afStudio.vp.unmask("center");this.widgetMetaData.definition=a;this.openWidgetDesigner(a)},error:function(a){afStudio.vp.unmask("center");var b=String.format('Fetching widget "{0}" data failed. <br/> {1}',this.widgetMetaData.widgetUri,a.message);afStudio.Msg.error(b)}})},openWidgetDesigner:function(a){this.add({xtype:"afStudio.wd.widgetTabPanel",widgetMeta:this.widgetMetaData});this.doLayout()}});Ext.reg("afStudio.wd.widgetPanel",afStudio.wd.WidgetPanel);Ext.ns("afStudio.wd");afStudio.wd.WidgetDefinition=Ext.extend(Ext.util.Observable,{constructor:function(a){a=a||{};Ext.apply(this,a);this.addEvents("datafetched","fetchingexception");afStudio.wd.WidgetDefinition.superclass.constructor.call(this)},fetchDefinition:function(a){var b=this;Ext.Ajax.request({url:afStudioWSUrls.getGetWidgetUrl(this.widgetUri),scope:a.scope?a.scope:b,success:function(e){var c=Ext.util.JSON.decode(e.responseText);if(c.success){var d=c.data;if(Ext.isFunction(a.success)){Ext.util.Functions.createDelegate(a.success,this,[d],false)()}b.fireEvent("datafetched",d)}else{if(Ext.isFunction(a.error)){Ext.util.Functions.createDelegate(a.error,this,[c],false)()}b.fireEvent("fetchingexception",c)}},failure:function(e,c){var d=String.format("Status code: {0}, message: {1}",e.status,e.statusText);afStudio.Msg.error("Server side error",d)}})},saveDefinition:function(b,d,a){var c=this,b=Ext.util.JSON.encode(b);Ext.Ajax.request({url:afStudioWSUrls.getSaveWidgetUrl(this.widgetUri),params:{data:b,widgetType:this.widgetType,createNewWidget:a?true:false},success:function(f){var e=Ext.decode(f.responseText);if(e.success){afStudio.Msg.info(e.message);if(Ext.isFunction(d)){d(e)}}else{afStudio.Msg.error(e.message)}},failure:function(g,e){var f=String.format("Status code: {0}, message: {1}",g.status,g.statusText);afStudio.Msg.error("Server side error",f)}})}});